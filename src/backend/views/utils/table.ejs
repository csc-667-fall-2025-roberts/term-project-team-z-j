<!-- Poker Table Component -->
<div class="relative w-full max-w-4xl mx-auto">
  <!-- Poker Table - Wooden Rim -->
  <div class="relative bg-gradient-to-b from-amber-800 via-amber-900 to-amber-950 shadow-2xl" style="border-radius: 180px; padding: 16px; width: 100%; height: 360px; box-shadow: 0 30px 60px -15px rgba(0, 0, 0, 0.6), inset 0 2px 8px rgba(255, 200, 100, 0.15), inset 0 -2px 8px rgba(0, 0, 0, 0.4);">
    
    <!-- Wood grain texture overlay -->
    <div class="absolute inset-0 opacity-25" style="border-radius: 180px; background-image: repeating-linear-gradient(90deg, transparent, transparent 3px, rgba(0,0,0,0.15) 3px, rgba(0,0,0,0.15) 6px);"></div>
    
    <!-- Table Surface (Green Felt) -->
    <div class="relative w-full h-full" id="pokerTableSurface" style="border-radius: 165px; background: linear-gradient(135deg, #3d9970 0%, #2d7a57 50%, #1e5a3d 100%); box-shadow: inset 0 10px 30px rgba(0, 0, 0, 0.5), inset 0 -5px 15px rgba(0, 0, 0, 0.3), 0 0 0 3px rgba(0, 0, 0, 0.2);">
      
      <!-- Felt texture overlay (noise) -->
      <div class="absolute inset-0 opacity-20" style="border-radius: 165px; background-image: url('data:image/svg+xml,%3Csvg viewBox=%220 0 200 200%22 xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cfilter id=%22noiseFilter%22%3E%3CfeTurbulence type=%22fractalNoise%22 baseFrequency=%221.2%22 numOctaves=%225%22 /%3E%3C/filter%3E%3Crect width=%22100%25%22 height=%22100%25%22 filter=%22url(%23noiseFilter)%22/%3E%3C/svg%3E'); background-size: 80px 80px;"></div>
      
      <!-- Subtle dot pattern for felt texture -->
      <div class="absolute inset-0 opacity-10" style="border-radius: 165px; background-image: radial-gradient(circle, rgba(0,0,0,0.4) 0.5px, transparent 0.5px); background-size: 6px 6px;"></div>
      
      <!-- Top-center highlight (glossy effect) -->
      <div class="absolute top-0 left-1/2 transform -translate-x-1/2 w-2/3 h-1/4 opacity-15" style="border-radius: 165px 165px 0 0; background: radial-gradient(ellipse at center top, rgba(255,255,255,0.8) 0%, transparent 60%);"></div>
      
      <!-- Inner rim shadow for depth -->
      <div class="absolute inset-0" style="border-radius: 165px; box-shadow: inset 0 0 50px rgba(0, 0, 0, 0.4);"></div>

      <%
        // Define player positions around the table (8 positions max)
        const allPositions = [
          'bottom-0 left-1/2 transform -translate-x-1/2 translate-y-20',  // Position 0 - Bottom
          'left-0 top-1/2 transform -translate-y-1/2 -translate-x-16',   // Position 1 - Left
          'top-0 left-1/2 transform -translate-x-1/2 -translate-y-16',   // Position 2 - Top
          'right-0 top-1/2 transform -translate-y-1/2 translate-x-16',   // Position 3 - Right
          'left-[15%] top-[15%] transform -translate-x-12 -translate-y-12', // Position 4 - Top-Left
          'right-[15%] top-[15%] transform translate-x-12 -translate-y-12', // Position 5 - Top-Right
          'left-[15%] bottom-[15%] transform -translate-x-12 translate-y-12', // Position 6 - Bottom-Left
          'right-[15%] bottom-[15%] transform translate-x-12 translate-y-12', // Position 7 - Bottom-Right
        ];

        // Sort players by position
        const sortedPlayers = [...players].sort((a, b) => a.position - b.position);
        
        // Find current user in sorted list
        let currentUserIndex = sortedPlayers.findIndex(p => p.user_id === userId);
        
        // If current user not found, default to 0
        if (currentUserIndex === -1) {
          currentUserIndex = 0;
        }
        
        // Reorder so current user is first (at bottom position)
        const reorderedPlayers = [];
        for (let i = 0; i < sortedPlayers.length; i++) {
          const index = (currentUserIndex + i) % sortedPlayers.length;
          reorderedPlayers.push(sortedPlayers[index]);
        }

        // Map players to visual positions based on player count
        // For 2 players: positions 0 (bottom) and 2 (top)
        // For 3 players: positions 0 (bottom), 1 (left), 3 (right)
        // For 4 players: positions 0, 1, 2, 3
        // For 5+ players: use all positions
        const visualPositionMap = {
          2: [0, 2],           // Bottom, Top
          3: [0, 1, 3],        // Bottom, Left, Right
          4: [0, 1, 2, 3],     // Bottom, Left, Top, Right
          5: [0, 1, 2, 3, 6],  // Add Bottom-Left
          6: [0, 1, 2, 3, 6, 7], // Add Bottom-Right
          7: [0, 1, 4, 2, 5, 3, 6], // Add Top-Left
          8: [0, 1, 4, 2, 5, 3, 6, 7] // All positions
        };

        const playerCount = reorderedPlayers.length;
        const positionIndices = visualPositionMap[playerCount] || visualPositionMap[8];
      %>
      
      <!-- Debug info (hidden) -->
      <script>
        console.log('[table.ejs] Rendered with userId:', <%= userId %>, 'players:', <%= JSON.stringify(sortedPlayers.map(p => ({ user_id: p.user_id, username: p.username }))) %>);
      </script>

      <% reorderedPlayers.forEach((player, index) => { 
        const positionIndex = positionIndices[index];
        const isCurrentUser = player.user_id === userId;
      %>
        <!-- Player <%= index %> (<%= player.username %>) at visual position <%= positionIndex %> -->
        <div 
          data-player="<%= player.user_id %>" 
          data-position="<%= player.position %>"
          data-visual-position="<%= positionIndex %>"
          class="absolute <%= allPositions[positionIndex] %> flex flex-col items-center <%= isCurrentUser ? 'gap-2' : 'gap-1.5' %>"
        >
          <!-- Cards -->
          <div class="player-cards flex <%= isCurrentUser ? 'gap-2 mb-1' : 'gap-1 mb-0.5' %>">
            <% if (isCurrentUser) { %>
              <!-- Current user sees their cards (placeholder for now) -->
              <img src="/cards/back_card.jpg" alt="Card" class="hole-card w-20 h-28 rounded-lg shadow-2xl transform hover:scale-105 transition-transform" style="filter: drop-shadow(0 8px 16px rgba(0,0,0,0.4));" />
              <img src="/cards/back_card.jpg" alt="Card" class="hole-card w-20 h-28 rounded-lg shadow-2xl transform hover:scale-105 transition-transform" style="filter: drop-shadow(0 8px 16px rgba(0,0,0,0.4));" />
            <% } else { %>
              <!-- Other players show card backs -->
              <img src="/cards/back_card.jpg" alt="Card Back" class="w-14 h-20 rounded-md shadow-lg" style="filter: drop-shadow(0 4px 8px rgba(0,0,0,0.4));" />
              <img src="/cards/back_card.jpg" alt="Card Back" class="w-14 h-20 rounded-md shadow-lg" style="filter: drop-shadow(0 4px 8px rgba(0,0,0,0.4));" />
            <% } %>
          </div>
          <!-- Player Info -->
          <% if (isCurrentUser) { %>
            <div class="bg-gradient-to-r from-gray-900 to-black rounded-full px-4 py-2 flex items-center gap-2.5 shadow-xl" style="border: 3px solid #fbbf24; box-shadow: 0 6px 16px rgba(0,0,0,0.5), 0 0 16px rgba(251, 191, 36, 0.3);">
              <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=<%= player.username %>" alt="<%= player.username %>" class="w-9 h-9 rounded-full border-2 border-white shadow-lg" />
              <div class="text-left">
                <div class="text-white font-bold text-xs tracking-wide">You</div>
                <div class="text-green-400 font-bold text-sm">$1,500</div>
              </div>
            </div>
          <% } else { %>
            <div class="bg-gradient-to-r from-gray-900 to-black rounded-full px-3 py-1.5 flex items-center gap-2 shadow-lg" style="border: 2px solid #4b5563; box-shadow: 0 4px 12px rgba(0,0,0,0.5);">
              <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=<%= player.username %>" alt="<%= player.username %>" class="w-8 h-8 rounded-full border-2 border-white shadow-md" />
              <div class="text-left">
                <div class="text-white font-bold text-xs"><%= player.username %></div>
                <div class="text-green-400 font-bold text-xs">$1,500</div>
              </div>
            </div>
          <% } %>
        </div>
      <% }); %>

      <!-- Community Cards (Center) -->
      <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-12 flex gap-1.5" id="communityCards">
        <!-- Cards will be dynamically added here by game.ts -->
      </div>

      <!-- Center Pot -->
      <div class="absolute top-[15%] left-[22%] transform -translate-x-1/2 -translate-y-1/2 flex flex-col items-center gap-0.5">
        <div class="text-white font-bold text-[10px] tracking-widest bg-black bg-opacity-70 px-2 py-0.5 rounded-full shadow-lg" style="letter-spacing: 0.1em;">POT</div>
        <div id="potAmount" class="text-yellow-400 font-bold text-2xl tracking-tight" style="text-shadow: 0 2px 10px rgba(251, 191, 36, 0.5), 0 0 20px rgba(251, 191, 36, 0.3);">$0</div>
      </div>
      
    </div>
  </div>
</div>
