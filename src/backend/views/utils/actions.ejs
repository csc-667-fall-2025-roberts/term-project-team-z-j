<!-- Action Controls Component -->
<div class="w-full max-w-6xl mx-auto mt-19">
  <div class="flex items-center justify-between gap-8 px-4">
    
    <!-- Left Side: Chat Button -->
    <div class="flex-shrink-0">
      <button id="chatToggle" class="flex items-center gap-2 text-gray-700 hover:text-gray-900 font-bold text-xl uppercase transition-all cursor-pointer tracking-wide" style="text-shadow: 1px 1px 2px rgba(255,255,255,0.8);">
        ðŸ’¬ <span>CHAT</span>
      </button>
    </div>

    <!-- Right Side: Action Buttons -->
    <div class="flex items-center gap-6">
      <button id="foldBtn" class="text-red-500 hover:text-red-600 font-extrabold text-2xl uppercase transition-all cursor-pointer tracking-wider hover:scale-105" style="text-shadow: 1px 1px 3px rgba(255,255,255,0.9), -1px -1px 3px rgba(255,255,255,0.9);">
        FOLD
      </button>
      <button id="checkBtn" class="text-green-600 hover:text-green-700 font-extrabold text-2xl uppercase transition-all cursor-pointer tracking-wider hover:scale-105" style="text-shadow: 1px 1px 3px rgba(255,255,255,0.9), -1px -1px 3px rgba(255,255,255,0.9);">
        CHECK
      </button>
      <button id="callBtn" class="text-blue-600 hover:text-blue-700 font-extrabold text-2xl uppercase transition-all cursor-pointer tracking-wider hover:scale-105" style="text-shadow: 1px 1px 3px rgba(255,255,255,0.9), -1px -1px 3px rgba(255,255,255,0.9);">
        CALL
      </button>
      <div class="flex items-center gap-4">
        <div class="text-gray-900 font-extrabold text-2xl tracking-wide" style="text-shadow: 1px 1px 2px rgba(255,255,255,0.7);">
          <span id="raiseAmount">$50</span>
        </div>
        <input type="range" id="betSlider" min="10" max="1000" value="50" step="10"
          class="w-56 h-2.5 rounded-lg appearance-none cursor-pointer"
          style="background: linear-gradient(to right, #60a5fa 0%, #3b82f6 100%);" />
        <button id="raiseBtn" class="text-orange-500 hover:text-orange-600 font-extrabold text-2xl uppercase transition-all cursor-pointer tracking-wider hover:scale-105" style="text-shadow: 1px 1px 3px rgba(255,255,255,0.9), -1px -1px 3px rgba(255,255,255,0.9);">
          RAISE
        </button>
        <button id="allinBtn" class="text-purple-600 hover:text-purple-700 font-extrabold text-2xl uppercase transition-all cursor-pointer tracking-wider hover:scale-105" style="text-shadow: 1px 1px 3px rgba(255,255,255,0.9), -1px -1px 3px rgba(255,255,255,0.9);">
          ALL-IN
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Chat Panel -->
<div id="chatPanel" class="hidden fixed left-4 bottom-24 w-96 bg-white rounded-xl shadow-2xl border border-gray-300 overflow-hidden" style="z-index: 1000;">
  <div id="chatHeader" class="bg-gradient-to-r from-blue-500 to-blue-600 p-4 flex justify-between items-center cursor-move">
    <h3 class="font-semibold text-white text-lg select-none">ðŸ’¬ Game Chat</h3>
    <button id="closeChatBtn" class="text-white hover:bg-white hover:bg-opacity-20 px-2 py-1 rounded transition">âœ•</button>
  </div>
  <div id="chatMessages" class="h-80 overflow-y-auto p-4 space-y-3 bg-gray-50">
    <p class="text-gray-400 text-center text-sm">Click CHAT to load messages...</p>
  </div>
  <div class="p-4 border-t bg-white">
    <div class="flex gap-2">
      <input type="text" id="chatInput" placeholder="Type a message..." 
        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" />
      <button id="sendChatBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded-lg transition-colors shadow-sm">
        Send
      </button>
    </div>
  </div>
</div>

<style>
  #betSlider::-webkit-slider-thumb {
    appearance: none;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    border: 2px solid white;
  }
  #betSlider::-moz-range-thumb {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    border: 2px solid white;
  }
</style>

<script>
(function() {
  // Slider
  var slider = document.getElementById('betSlider');
  var raiseAmountDisplay = document.getElementById('raiseAmount');
  if (slider && raiseAmountDisplay) {
    slider.addEventListener('input', function(e) {
      raiseAmountDisplay.textContent = '$' + e.target.value;
    });
  }

  // Chat panel elements
  var chatToggle = document.getElementById('chatToggle');
  var chatPanel = document.getElementById('chatPanel');
  var closeChatBtn = document.getElementById('closeChatBtn');
  var sendChatBtn = document.getElementById('sendChatBtn');
  var chatInput = document.getElementById('chatInput');
  var chatMessages = document.getElementById('chatMessages');
  
  // Chat panel toggle
  if (chatToggle && chatPanel) {
    chatToggle.addEventListener('click', function() {
      chatPanel.classList.toggle('hidden');
      if (!chatPanel.classList.contains('hidden')) {
        loadChatMessages();
      }
    });
  }
  
  if (closeChatBtn && chatPanel) {
    closeChatBtn.addEventListener('click', function() {
      chatPanel.classList.add('hidden');
    });
  }

  // Draggable chat panel
  var chatHeader = document.getElementById('chatHeader');
  var isDragging = false;
  var currentX = 0, currentY = 0, initialX = 0, initialY = 0;
  var xOffset = 0, yOffset = 0;

  if (chatHeader && chatPanel) {
    chatHeader.addEventListener('mousedown', function(e) {
      if (e.target === closeChatBtn || e.target.closest('#closeChatBtn')) return;
      initialX = e.clientX - xOffset;
      initialY = e.clientY - yOffset;
      isDragging = true;
    });
    
    document.addEventListener('mousemove', function(e) {
      if (isDragging) {
        e.preventDefault();
        currentX = e.clientX - initialX;
        currentY = e.clientY - initialY;
        xOffset = currentX;
        yOffset = currentY;
        chatPanel.style.transform = 'translate(' + currentX + 'px, ' + currentY + 'px)';
      }
    });
    
    document.addEventListener('mouseup', function() {
      initialX = currentX;
      initialY = currentY;
      isDragging = false;
    });
  }

  // Helper functions
  function escapeHtml(text) {
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  function formatTime(dateString) {
    var date = new Date(dateString);
    return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
  }
  
  // Show chat message - exposed globally for socket handler in game.ejs
  function showChatMessage(msg) {
    if (!chatMessages) return;
    
    // Remove placeholder
    var placeholder = chatMessages.querySelector('.text-gray-400.text-center');
    if (placeholder) placeholder.remove();
    
    // Use sender_id (from API) or user_id (from socket)
    var senderId = msg.sender_id || msg.user_id;
    var isCurrentUser = senderId === window.currentUserId;
    var time = formatTime(msg.created_at);
    var username = escapeHtml(msg.username || 'Unknown');
    var content = escapeHtml(msg.content);
    
    var messageDiv = document.createElement('div');
    messageDiv.className = 'flex gap-3 items-start';
    
    var borderClass = isCurrentUser ? 'border-blue-300' : 'border-gray-300';
    var bgClass = isCurrentUser ? 'bg-blue-100 border-blue-200' : 'bg-white border-gray-200';
    
    messageDiv.innerHTML = 
      '<img src="https://api.dicebear.com/7.x/avataaars/svg?seed=' + username + '" alt="' + username + '" class="flex-shrink-0 w-10 h-10 rounded-full border-2 ' + borderClass + ' shadow-md" />' +
      '<div class="flex-1">' +
        '<div class="flex items-baseline gap-2 mb-1">' +
          '<span class="font-semibold text-gray-900 text-sm">' + username + '</span>' +
          '<span class="text-xs text-gray-500">' + time + '</span>' +
        '</div>' +
        '<div class="' + bgClass + ' p-3 rounded-lg rounded-tl-none shadow-sm border">' +
          '<p class="text-gray-700 text-sm">' + content + '</p>' +
        '</div>' +
      '</div>';
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }
  
  // Expose showChatMessage globally so game.ejs socket can call it
  window.showChatMessage = showChatMessage;
  
  // Load chat messages from API
  function loadChatMessages() {
    if (!chatMessages) return;
    
    var gameId = window.currentGameId;
    console.log('[Chat] Loading messages for game:', gameId);
    
    if (!gameId) {
      chatMessages.innerHTML = '<p class="text-red-400 text-center text-sm">Game ID not found</p>';
      return;
    }
    
    chatMessages.innerHTML = '<p class="text-gray-400 text-center text-sm">Loading...</p>';
    
    fetch('/api/rooms/' + gameId + '/messages')
      .then(function(response) {
        return response.json();
      })
      .then(function(data) {
        console.log('[Chat] Messages loaded:', data);
        
        if (data.success && data.messages && data.messages.length > 0) {
          chatMessages.innerHTML = '';
          data.messages.forEach(function(msg) {
            showChatMessage(msg);
          });
        } else if (data.error) {
          chatMessages.innerHTML = '<p class="text-red-400 text-center text-sm">' + escapeHtml(data.error) + '</p>';
        } else {
          chatMessages.innerHTML = '<p class="text-gray-400 text-center text-sm">No messages yet. Start the conversation!</p>';
        }
      })
      .catch(function(error) {
        console.error('[Chat] Failed to load messages:', error);
        chatMessages.innerHTML = '<p class="text-red-400 text-center text-sm">Failed to load messages</p>';
      });
  }
  
  // Send chat message
  function sendChatMessage() {
    if (!chatInput || !chatMessages) return;
    
    var gameId = window.currentGameId;
    var content = chatInput.value.trim();
    
    if (!content || !gameId) return;
    
    chatInput.disabled = true;
    if (sendChatBtn) sendChatBtn.disabled = true;
    
    fetch('/api/rooms/' + gameId + '/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ content: content })
    })
    .then(function(response) {
      return response.json();
    })
    .then(function(data) {
      if (data.success) {
        chatInput.value = '';
      } else {
        console.error('[Chat] Failed to send:', data.error);
      }
    })
    .catch(function(error) {
      console.error('[Chat] Error sending message:', error);
    })
    .finally(function() {
      chatInput.disabled = false;
      if (sendChatBtn) sendChatBtn.disabled = false;
      chatInput.focus();
    });
  }
  
  if (sendChatBtn) {
    sendChatBtn.addEventListener('click', sendChatMessage);
  }
  
  if (chatInput) {
    chatInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        sendChatMessage();
      }
    });
  }
})();
</script>
